{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.1272.37030",
      "templateHash": "16523096064252900476"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "enabledForDeployment": {
      "type": "bool",
      "defaultValue": true
    },
    "enabledForTemplateDeployment": {
      "type": "bool",
      "defaultValue": true
    },
    "enabledForDiskEncryption": {
      "type": "bool",
      "defaultValue": true
    },
    "enableSoftDelete": {
      "type": "bool",
      "defaultValue": true
    },
    "enablePurgeProtection": {
      "type": "bool",
      "defaultValue": true
    },
    "keyVaultName": {
      "type": "string",
      "defaultValue": "XYZkv9"
    },
    "tenantId": {
      "type": "string",
      "defaultValue": "[subscription().tenantId]"
    },
    "objectId": {
      "type": "string",
      "defaultValue": "214bb771-fd30-4f8e-9dfc-7195f7b165ff",
      "metadata": {
        "description": "Specifies the object ID of a user, service principal or security group in the Azure Active Directory tenant for the vault. The object ID must be unique for the list of access policies. Get it by using Get-AzADUser or Get-AzADServicePrincipal cmdlets."
      }
    },
    "skuName": {
      "type": "string",
      "defaultValue": "standard",
      "allowedValues": [
        "standard"
      ],
      "metadata": {
        "description": "Specifies whether the key vault is a standard vault or a premium vault."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2019-09-01",
      "name": "[parameters('keyVaultName')]",
      "location": "[parameters('location')]",
      "tags": {
        "projectv1": "jamaltadrous"
      },
      "properties": {
        "enabledForDeployment": "[parameters('enabledForDeployment')]",
        "enabledForTemplateDeployment": "[parameters('enabledForTemplateDeployment')]",
        "enabledForDiskEncryption": "[parameters('enabledForDiskEncryption')]",
        "enableRbacAuthorization": false,
        "tenantId": "[parameters('tenantId')]",
        "enableSoftDelete": "[parameters('enableSoftDelete')]",
        "enablePurgeProtection": "[parameters('enablePurgeProtection')]",
        "softDeleteRetentionInDays": 7,
        "accessPolicies": [
          {
            "objectId": "[parameters('objectId')]",
            "tenantId": "[parameters('tenantId')]",
            "permissions": {
              "keys": [
                "all"
              ],
              "secrets": [
                "all"
              ],
              "certificates": [
                "all"
              ],
              "storage": [
                "all"
              ]
            }
          }
        ],
        "sku": {
          "name": "[parameters('skuName')]",
          "family": "A"
        },
        "networkAcls": {
          "defaultAction": "Allow",
          "bypass": "AzureServices"
        }
      }
    },
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2018-11-30",
      "name": "XYZadmin",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2021-10-01",
      "name": "[format('{0}/{1}', parameters('keyVaultName'), 'ssh')]",
      "properties": {
        "value": "-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEAxV7VWxWjQAL5n0FUJTFpMrkp0iE/5YMKQTy496KDKPl3Ty7J\nlSCiRwGkBC5v8lYNyqhh4wFzMIK/rvMDl6M4nAVr9vOTuW3cJFjV0WDxpzoM1ab5\nj/IP/DUGnsIQRJqOQFw9trBdSXNSqRwQKyZW0/Wx22Uv/Hdp5YdQc6qTXCVcYqyW\nTRasC1pfTrVj1hl/De641hDu5YRSM5AjPmQiLaPzSNuoxxyMuCDK4Uoz2nYqHLTm\n5UwmQdFJp8twf1nZQZ3IwVdj63WjNVYwSYwuqwI5m8zq1KmIf16gMacn3Q0itZDJ\n6fdgwxrUICyciLQU4aPufaKN+3dgvsxnJ4V1LQIDAQABAoIBACHHKRx9h4Lc/3uR\n4qS64BYeOloL9rOAybCAg+ddmLTafODAUR+EhkFAtqFAkUgYEiQszRPcm6ohtkxq\nqqK4/Gc3RlLtPMrvUk2mJnG+9Zx5AtlNykgoVTQEny1saPxUtyOspaMua8i2Q99N\nPjckSJfd5KJ3ns7GYQk3Lz2cY7vRG7oJVhR/g2CAlVIJC/d1g7kpNRZaaJ6+RODL\n/uBhgnjwGAVu7qnJoWmaWBSramrNJER9gzZoqWEjPN4Zf9xTNyvanR1nUtmAzfOa\nHgytOHn0BojjysDdrTPlhEI2z5wygI/5i70oqPMAjD2E/ASkVaZoW4HwhMhE8Z3J\nExiyDsECgYEA+Jn1sBzR8ICtSyPErixPIftvbtys2qaAqTBR7GYlsPTggIj2O+jR\nBI7lbFviMMZt+S+v1NjLFqfe/vzG1aXjKSrCrNupaRQzMpGQX01N/RdG0tySNRwP\ns1vo4exoG7G+qThFq4qstWAyIEVua9g/77HPlcQ6+BQMQh89USJXXz8CgYEAyz6O\nXDH3f0jZ3VQ+io8Y/WwKGiTcQDm+jl/7ZDYW77SBU5UCjBNsgj6CixjdQnrYAcdd\nRXOVJsAA8eVNsKDJ3zhpsc7vtW92II/ePx5QVe6+rUywN/0QkHJHiveSoo9SM1Df\n2ZAgiG1IZnpN276wKsjkAZLI8EVqh18KgEA5PJMCgYBX/zdmVW1Csmmk9U5DUM/Z\n+YRiO5677sAQI1h8U1P4JVXqaZCveCO0d1hiWMvh8/stf2G/99U7ecSHgbZoHcYg\n5k/um/qFhW7x8XCnK1f1xG1/ajAeuIYeOORgRCw90Vbp009l/zpPIXPc1HbXmb5X\n/Bq8qq8s7PvB1AkCVSOURQKBgQCQdGHSfWEfgrP2b44UBSkJ1eRIOLKio2gg4W9Y\nBmm+7ViOA3bQAG47FBrMqlt4iL9GZGCSoFf+NrF1PDk/tMhGc14MFryhBBu9gQPB\ncNZAfXPg0ITfBmrjf5YB23zJNXyDJJQ1mg7FaIbw7zSvXpTvk+EajS1sOKpClPZt\nuTf1KQKBgC7xyAgMAi1bFnUdQbgNynaFMYS6CxR+1vvtHfULdCAexCPvE3juxS9z\nHkMY5iYEBuR5ouc64rxXHL6tTXCUCcHLbphg1clppyQ9QfUgR8n/HoccQChzqRHK\neAQgwJLgIjoSCL/E65guODaBzuMRpFF+2O7gu2EHbR1/CTvMyERC\n-----END RSA PRIVATE KEY-----\n"
      },
      "tags": {
        "projectv1": "jamaltadrous"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults/keys",
      "apiVersion": "2021-10-01",
      "name": "[format('{0}/{1}', parameters('keyVaultName'), 'RSAKey')]",
      "properties": {
        "kty": "RSA",
        "keySize": 4096,
        "keyOps": [
          "encrypt",
          "decrypt",
          "sign",
          "unwrapKey",
          "verify",
          "wrapKey"
        ],
        "attributes": {
          "enabled": true
        }
      },
      "tags": {
        "projectv1": "jamaltadrous"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
      ]
    },
    {
      "type": "Microsoft.Compute/diskEncryptionSets",
      "apiVersion": "2021-08-01",
      "name": "dskEncrKeyV1",
      "location": "[parameters('location')]",
      "tags": {
        "projectv1": "jamaltadrous"
      },
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "rotationToLatestKeyVersionEnabled": true,
        "activeKey": {
          "keyUrl": "[reference(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), 'RSAKey')).keyUriWithVersion]",
          "sourceVault": {
            "id": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
          }
        },
        "encryptionType": "EncryptionAtRestWithCustomerKey"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
        "[resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), 'RSAKey')]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults/accessPolicies",
      "apiVersion": "2021-10-01",
      "name": "[format('{0}/{1}', parameters('keyVaultName'), 'add')]",
      "properties": {
        "accessPolicies": [
          {
            "tenantId": "[parameters('tenantId')]",
            "objectId": "[reference(resourceId('Microsoft.Compute/diskEncryptionSets', 'dskEncrKeyV1'), '2021-08-01', 'full').identity.principalId]",
            "permissions": {
              "keys": [
                "all"
              ],
              "storage": [
                "all"
              ]
            }
          },
          {
            "tenantId": "[parameters('tenantId')]",
            "objectId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'XYZadmin')).principalId]",
            "permissions": {
              "keys": [
                "all"
              ],
              "secrets": [
                "all"
              ],
              "certificates": [
                "all"
              ],
              "storage": [
                "all"
              ]
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/diskEncryptionSets', 'dskEncrKeyV1')]",
        "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'XYZadmin')]"
      ]
    }
  ],
  "outputs": {
    "KeyvaultUri": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))).vaultUri]"
    },
    "mngId": {
      "type": "string",
      "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'XYZadmin')]"
    },
    "keyvaultId": {
      "type": "string",
      "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
    },
    "proxyKey": {
      "type": "object",
      "value": "[reference(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), 'RSAKey'), '2021-10-01', 'full')]"
    },
    "objectId": {
      "type": "string",
      "value": "[parameters('objectId')]"
    },
    "dskEncrKey": {
      "type": "string",
      "value": "[resourceId('Microsoft.Compute/diskEncryptionSets', 'dskEncrKeyV1')]"
    }
  }
}